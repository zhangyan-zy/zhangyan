<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wingscode.modules.common.dao.LeadsDao">

	<select id="queryList" resultType="long">
		select id from tb_leads where parent_id = #{parentId} and name like #{name}
	</select>


	<insert id="addiphone">
		UPDATE tb_leads l , tb_mobile m
        SET l.province = m.province,l.city =m.city , l.area_code =  m.area_code
        where m.mobile = left(l.phone, 7)  and l.id=#{leadsId}
	</insert>


	<select id="selectProvince" resultType="String">
		 SELECT DISTINCT(province) from tb_leads where province  is not null
	</select>

	<select id="selectCity" resultType="String">
		 SELECT DISTINCT(city) from tb_leads
		 where   province=#{province}
	</select>

	<insert id="addTracs" parameterType="com.wingscode.modules.common.entity.TraceEntity">
          insert  into tb_trace(gmt_creat,gmt_modified,leads_id,content)
          values
          (#{traceEntity.gmtCreat},#{traceEntity.gmtModified},#{traceEntity.leadsId},#{traceEntity.content})
      </insert>

	 <select id="selectTrace" resultType="com.wingscode.modules.common.entity.TraceEntity">
		 select * from tb_trace where 1=1
		 <if test="leadsId !=null and leadsId !=''">
		    and leads_id=#{leadsId}
		 </if>
		 order by gmt_creat desc
	 </select>

	<select id="selectTraceByCustomer" resultType="com.wingscode.modules.common.entity.TraceEntity">
      SELECT
	    t.* , l.name leadsName
      FROM
	    tb_trace t
	       LEFT JOIN tb_leads l ON t.leads_id = l.id
	    where 1=1
	    <if test="username !=null and username !=''">
			and  l.name  like
			concat('%',#{username},'%')
    	</if>
		<if test="mobile !=null and mobile !=''">
			and  l.phone  like
			concat('%',#{mobile},'%')
		</if>
		<if test="amount1 !=null and amount1 !='' and amount1 !=0 and amount2 !=null and amount2 !='' and amount2 !=0 ">
           and  l.amount between  #{amount1} and #{amount2}
		</if>
		<if test="status !=null and status !=''">
			and  l.status=#{status}
		</if>
		<if test="date1 !=null and date1 !='' and date2 !=null and date2 !='' ">
            and  t.gmt_creat between #{date1} and #{date2}
		</if>
		order by t.gmt_creat desc
	</select>
</mapper>
